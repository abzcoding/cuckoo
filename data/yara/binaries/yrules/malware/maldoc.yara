/*
  Version 0.0.2 2014/12/16
  Source code put in public domain by Didier Stevens, no Copyright
  https://DidierStevens.com
  Use at your own risk

  These are YARA rules to detect shellcode, translated from XORSearch's wildcard rules,
  which themselves were developed based on Frank Boldewin's shellcode detector used in OfficeMalScanner.

  Shortcomings, or todo's ;-) :
    Remaining XORSearch wildcard rules:
      GetEIP method 2:10:EB(J;1)E8(J;4)(B;01011???)
      GetEIP method 3:10:E9(J;4)E8(J;4)(B;01011???)

  History:
    2014/12/15: start
    2014/12/16: extra documentation
*/

/*
XORSearch wildcard rule(s):
    Function prolog signature:10:558BEC83C4
    Function prolog signature:10:558BEC81EC
    Function prolog signature:10:558BECEB
    Function prolog signature:10:558BECE8
    Function prolog signature:10:558BECE9
*/
rule maldoc_function_prolog_signature
{
    meta:
        author = "Didier Stevens (https://DidierStevens.com)"
    strings:
        $a1 = {55 8B EC 81 EC}
        $a2 = {55 8B EC 83 C4}
        $a3 = {55 8B EC E8}
        $a4 = {55 8B EC E9}
        $a5 = {55 8B EC EB}
    condition:
        any of them
}

/*
XORSearch wildcard rule(s):
    Structured exception handling :10:648B(B;00???101)00000000
    Structured exception handling bis:10:64A100000000
*/
rule maldoc_structured_exception_handling
{
    meta:
        author = "Didier Stevens (https://DidierStevens.com)"
    strings:
        $a1 = {64 8B (05|0D|15|1D|25|2D|35|3D) 00 00 00 00}
        $a2 = {64 A1 00 00 00 00}
    condition:
        any of them
}



/*
XORSearch wildcard rule(s):
    Suspicious strings:2:str=UrlDownloadToFile
    Suspicious strings:2:str=GetTempPath
    Suspicious strings:2:str=GetWindowsDirectory
    Suspicious strings:2:str=GetSystemDirectory
    Suspicious strings:2:str=WinExec
    Suspicious strings:2:str=ShellExecute
    Suspicious strings:2:str=IsBadReadPtr
    Suspicious strings:2:str=IsBadWritePtr
    Suspicious strings:2:str=CreateFile
    Suspicious strings:2:str=CloseHandle
    Suspicious strings:2:str=ReadFile
    Suspicious strings:2:str=WriteFile
    Suspicious strings:2:str=SetFilePointer
    Suspicious strings:2:str=VirtualAlloc
    Suspicious strings:2:str=GetProcAddr
    Suspicious strings:2:str=LoadLibrary
*/
rule maldoc_suspicious_strings
{
    meta:
        author = "Didier Stevens (https://DidierStevens.com)"
    strings:
        $a01 = "CloseHandle"
        $a02 = "CreateFile"
        $a03 = "GetProcAddr"
        $a04 = "GetSystemDirectory"
        $a05 = "GetTempPath"
        $a06 = "GetWindowsDirectory"
        $a07 = "IsBadReadPtr"
        $a08 = "IsBadWritePtr"
        $a09 = "LoadLibrary"
        $a10 = "ReadFile"
        $a11 = "SetFilePointer"
        $a12 = "ShellExecute"
        $a13 = "UrlDownloadToFile"
        $a14 = "VirtualAlloc"
        $a15 = "WinExec"
        $a16 = "WriteFile"
    condition:
        any of them
}
